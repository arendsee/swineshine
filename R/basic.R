#' Load a new swine surveillance report
#'
#' @param filename The name of an excel file
#' @param sheet The sheet in the excel file that contains the data.
#' @export
load_file <- function(filename, sheet = 1) {
  my.data <- readxl::read_excel(filename, sheet = sheet, col_types = "text") %>%
    clean_data(.) %>%
    dplyr::mutate(region = abbr2state(state_str = State)) # necessary for the state map

  # ===== Convert Excell dates to R dates, Date only run once
  my.data$Date <- my.data$Date %>%
    as.numeric() %>%
    zoo::as.Date(origin = "1899-12-30")

  return(my.data)
}

#' Load the current swine surveillance data
#'
#' @export
load_current <- function() {
  infile <- system.file("app-data", "A0_Master_List.xlsx", package = "octoflushow")
  sheet <- "Data"
  my.data <- load_file(infile, sheet = sheet)

  return(my.data)
}

#' Clean the dataset
#' @param df Datatable containing swine surveillance information
#' @return Return a data table with standardized clade names and filtered datasets
#' @export

clean_data <- function(d, remove_mixed = TRUE) {
  my.data <- d

  # ===== Remove the single weird H4 strain
  # my.data <- subset(my.data, (is.na(H3) || H3 != "H4"))

  my.data <- my.data %>% dplyr::mutate(
    H1 = fixH1names(H1),
    H3 = fixH3names(H3),
    N1 = fixN1names(N1),
    N2 = fixN2names(N2),
    PB2 = fixIGnames(PB2),
    PB1 = fixIGnames(PB1),
    PA = fixIGnames(PA),
    NP = fixIGnames(NP),
    M = fixIGnames(M),
    NS = fixIGnames(NS)
  )

  #  my.data$State <- droplevels(factor(my.data$State))
  #  my.data$Subtype <- droplevels(factor(my.data$Subtype))
  #  my.data$US_Clade <- droplevels(factor(my.data$US_Clade))
  #  my.data$GL_Clade <- droplevels(factor(my.data$GL_Clade))
  #
  #   my.data$H1 <- droplevels(factor(my.data$H1))
  #   my.data$H3 <- droplevels(factor(my.data$H3))
  #   my.data$N1 <- droplevels(factor(my.data$N1))
  #   my.data$N2 <- droplevels(factor(my.data$N2))
  #   my.data$PB2 <- droplevels(factor(my.data$PB2))
  #   my.data$PB1 <- droplevels(factor(my.data$PB1))
  #   my.data$PA <- droplevels(factor(my.data$PA))
  #   my.data$NP <- droplevels(factor(my.data$NP))
  #   my.data$M <- droplevels(factor(my.data$M))
  #   my.data$NS <- droplevels(factor(my.data$NS))

  d <- my.data
  if (remove_mixed) {
    # e.g., ("unknown,TRIG" -> "unknown")
    d$H1 <- gsub(",.*", "", d$H1)
    d$H3 <- gsub(",.*", "", d$H3)
    d$N1 <- gsub(",.*", "", d$N1)
    d$N2 <- gsub(",.*", "", d$N2)
    d$PB2 <- gsub(",.*", "", d$PB2)
    d$PB1 <- gsub(",.*", "", d$PB1)
    d$PA <- gsub(",.*", "", d$PA)
    d$NP <- gsub(",.*", "", d$NP)
    d$M <- gsub(",.*", "", d$M)
    d$NS <- gsub(",.*", "", d$NS)
  }
  d
}

#' Return regular or federal quarters
#' @param dates Vector of date values
#' @param fed True for returning federal quarters (19Q1 -> 19Q2)
#' @return Return a vector of quarters from the dates YYQ1 - YYQ4
#' @export

date2quarter <- function(dates, fed = FALSE){
  temp <- data.frame(dates = dates, 
                     Year=lubridate::year(dates), 
                     Quarter = lubridate::quarter(dates))
  if(fed){
    temp$Quarter = temp$Quarter+1
    temp$Year[temp$Quarter>4] = temp$Year[temp$Quarter>4] +1
    temp$Quarter[temp$Quarter>4] = 1
  }
  temp$qtr = paste(temp$Year, temp$Quarter, sep="Q") %>% substr(., 3,6)
  return(temp$qtr)
}

#' Count number of entries by time chunk
#' @param df is dataframe containing a column of Date and clade to count by.
#' @param col_name by default is "H1" but can change it to "N2","Subtype","region", etc.
#' @param Date by default is "Date" but can change if column name is different.
#' @param tunit is "month", "quarter" or "year".
#' @param minDate is default NULL, but can expand the date range lubridate::as_date("2019-01-01")
#' @param maxDate is default NULL, but can expand the date range
#' @return a datatable with columns Date, Clade, n (counts)
#' @export
countByTimeUnit <- function(df, col_name="H1", Date="Date", tunit="month", 
                            minDate=NULL, maxDate=NULL){
  # Get range of dates in order to fill in missing date values
  if(is.null(minDate)){ 
    minDate <-df[[Date]] %>% min(.) 
  }
  if(is.null(maxDate)){
    maxDate <- df[[Date]] %>% max(.)
  }
  minDate <- lubridate::floor_date(minDate, unit=tunit)
  maxDate <- lubridate::floor_date(maxDate, unit=tunit)

  # Count isolates by clade/subtype/state (col_name)
  cdf <- df %>%
    dplyr::select(., c(Date, col_name)) %>%
    dplyr::mutate(
      Date = zoo::as.Date(lubridate::as_datetime(lubridate::floor_date(zoo::as.Date(Date), unit=tunit)))
    ) %>%
    dplyr::group_by(.dots=c(Date, col_name)) %>%
    dplyr::summarise(
      n=dplyr::n()
    )%>%
    dplyr::ungroup(.) %>%
    tidyr::complete(Date=seq.Date(minDate, maxDate, by=tunit)) # fill in missing dates
  
  # For the missing dates, fill in a placeholder clade label and n=0
  for(col_i in col_name){
    placeholder = cdf[[col_i]][!is.na(cdf[[col_i]])] %>% unique(.) %>% {.[1]}
    cdf[[col_i]][is.na(cdf[[col_i]])]=placeholder
  }
  cdf$n[is.na(cdf$n)] <- 0
  return(cdf)
}

# ==== Private functions
# ===== Standardize clade names
fixH1names <- function(h1) {
  h1 %>%
    replace(., . == "pdm", "pandemic") %>%
    replace(., . == "gamma.1" | . == "gamma.2" | . == "gamma.3", "gamma")
}

fixH3names <- function(h3) {
  h3 %>%
    replace(., . == "human-like_2010" | . == "human-like_2010.1" | . == "Human-like_2010.1", "2010.1") %>%
    replace(., . == "human-like_2016" | . == "human-like_2010.2" | . == "Human-like_2010.2", "2010.2") %>%
    replace(., . == "Other-human", "other-human") %>%
    gsub("Cluster_", "", .) %>%
    gsub("IV", "IV-", .) %>%
    gsub("--", "-", .) %>%
    replace(., . == "IV-", "IV")
}

fixN1names <- function(n1) {
  n1 %>%
    replace(., . == "pandemic", "Pandemic") %>%
    replace(., . == "classical", "Classical")
}

fixN2names <- function(n2) {
  n2 %>%
    replace(., . == "02" | . == "02A_1" | . == "02A_2" | . == "02B_1" | . == "02B_2" | . == "2002A" | . == "2002B", "2002") %>%
    replace(., . == "98" | . == "98A_1" | . == "98A_2" | . == "98B_1" | . == "98B_2" | . == "1998A" | . == "1998B", "1998") %>%
    replace(., . == "02A1" | . == "02A2" | . == "02B1" | . == "02B2" | . == "02A" | . == "02B", "2002") %>%
    replace(., . == "98A1" | . == "98A2" | . == "98B1" | . == "98B2" | . == "98A" | . == "98B", "1998") %>%
    replace(., . == "2002B,2002" | . == "2002,2002B", "2002")
}

fixIGnames <- function(ig) {
  replace(ig, ig == "VTX98", "TX98")
}
